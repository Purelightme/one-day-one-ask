```以下所有讨论都是基于MySQL的Innodb引擎```

![1](https://raw.githubusercontent.com/Purelightme/one-day-one-ask/master/images/1.1.png)

### 乐观锁

乐观锁不是数据库自带的，需要我们自己去实现。乐观锁是指操作数据库时(更新操作)，想法很乐观，认为这次的操作不会导致冲突，在操作数据时，并不进行任何其他的特殊处理（也就是不加锁），而在进行更新后，再去判断是否有冲突了。

通常实现是这样的：在表中的数据进行操作时(更新)，先给数据表加一个版本(version)字段，每操作一次，将那条记录的版本号加1。也就是先查询出那条记录，获取出version字段,如果要对那条记录进行操作(更新),则先判断此刻version的值是否与刚刚查询出来时的version的值相等，如果相等，则说明这段期间，没有其他程序对其进行操作，则可以执行更新，将version字段的值加1；如果更新时发现此刻的version值与刚刚获取出来的version的值不相等，则说明这段期间已经有其他程序对其进行操作了，则不进行更新操作。

乐观锁适用于多读的应用类型，这样可以提高吞吐量。

举例：

下单操作包括3步骤：

1.查询出商品信息

select (id,sales,version) from products where id={id}

2.根据商品信息生成订单

3.修改商品sale销量加1

update products set sales=sales+1,version=version+1where id={id} and version={version};



### 悲观锁

悲观锁，正如其名，它指的是对数据被外界（包括本系统当前的其他事务，以及来自外部系统的事务处理）修改持保守态度(悲观)，因此，在整个数据处理过程中，将数据处于锁定状态。 悲观锁的实现，往往依靠数据库提供的锁机制 （也只有数据库层提供的锁机制才能真正保证数据访问的排他性，否则，即使在本系统中实现了加锁机制，也无法保证外部系统不会修改数据）。

悲观锁分为共享锁(又称为读锁，简称S锁，顾名思义，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是*只能读，不能修改(这里我做实验了，貌似有问题，见文末)*。)和排它锁(又称为写锁，简称X锁，顾名思义，排它锁就是不能与其他锁并存，如一个事务获取了一个数据行的排它锁，其他事务就不能再获取该行的其他锁，包括共享锁，排它锁，但是获取排它锁的事务是可以进行数据的读写的。)。

简单说，在一个事务中共享锁上锁后，使用共享锁，排它锁，普通查询都能查到数据；排它锁上锁后，共享锁不能读取数据，普通查询可以读取数据。

关于锁的级别需要注意的点：行级锁是基于索引的，如果查询没有用到索引，那Innodb实际上也是表锁。

#### 排它锁

要使用悲观锁，我们必须关闭MySQL数据库的自动提交属性，因为MySQL默认使用autocommit模式，也就是说，当你执行一个更新操作后，MySQL会立刻将结果进行提交。

如果是使用begin……commit形式，就不需要设置set autocommit=0了，默认就是显示提交。

窗口A操作：

![2](https://raw.githubusercontent.com/Purelightme/one-day-one-ask/master/images/1.2.png)

窗口B操作：

![1.3](https://raw.githubusercontent.com/Purelightme/one-day-one-ask/master/images/1.3.png)

#### 共享锁

窗口A操作：

![1.4](https://raw.githubusercontent.com/Purelightme/one-day-one-ask/master/images/1.4.png)

窗口B操作：

![1.4](https://raw.githubusercontent.com/Purelightme/one-day-one-ask/master/images/1.4.png)

窗口A再操作：

![1.5](https://raw.githubusercontent.com/Purelightme/one-day-one-ask/master/images/1.5.png)

额，问题解决了，在有两个事务同时持有同一行的共享锁的时候，两边都是不能修改数据的。如果一行只有一个共享锁，那这个共享锁是可以修改数据的。

#### 疑问

###### 关于共享锁能不能修改数据的问题

mysql> set autocommit=0;
Query OK, 0 rows affected (0.01 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from orders where id=1 lock in share mode;
+----+---------+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------+---------------------+---------------------+--------+--------+-------------+---------------------+---------------------+----------------+-------------+
| id | user_id | order_no           | specification_snapshot                                                                                                                                                                                                                                                                                                                                                                                                                        | address_snapshot                                                                                                                                                                                                                                                             | payment_img                                 | pay_time            | receive_time        | amount | status | canceled_by | created_at          | updated_at          | product_number | express_fee |
+----+---------+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------+---------------------+---------------------+--------+--------+-------------+---------------------+---------------------+----------------+-------------+
|  1 |       1 | 201906180702599064 | [{"price": "99.00", "number": "1", "long_title": "2019???????????????", "product_id": 1, "image_cover": "images/eb2c6d0fe75a4bdc3ec05a7ae6ec75c5.jpg", "specification_string": "??;XL", "product_specification_id": 1}, {"price": "45.00", "number": "1", "long_title": "2019???????????????", "product_id": 1, "image_cover": "images/eb2c6d0fe75a4bdc3ec05a7ae6ec75c5.jpg", "specification_string": "??;L", "product_specification_id": 5}] | {"id": 1, "area": "???", "city": "???", "name": "??", "phone": "16601126817", "street": "??????A?1301", "area_id": "360102", "user_id": 1, "province": "???", "created_at": "2019-06-17 01:52:58", "deleted_at": null, "is_default": 1, "updated_at": "2019-06-17 10:23:01"} | images/8c5001a61f41a89dd05e5b9ceb446347.png | 2019-06-18 16:02:47 | 2019-06-20 13:47:48 | 152.00 |      6 |        NULL | 2019-06-18 07:02:59 | 2019-06-20 13:47:48 |              2 |        8.00 |
+----+---------+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------+---------------------+---------------------+--------+--------+-------------+---------------------+---------------------+----------------+-------------+
1 row in set (0.00 sec)

mysql> update orders set id=100 where id=1;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> commit;
Query OK, 0 rows affected (0.01 sec)

事务提交后，我查看数据库，数据确实是更新了的，所以，共享锁（读锁）是否能修改数据？

答：在有两个事务同时持有同一行的共享锁的时候，两边都是不能修改数据的。如果一行只有一个共享锁，那这个共享锁是可以修改数据的。

```2019-06-26```